# Copyright (C) 2019,2020 IBM Corporation
#
# Licensed under the Apache License, Version 2.0 (the “License”);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an “AS IS” BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

################################################################################
# NAME
#   compress_data - package and compress files and directories
# SYNOPSIS
#   compress_data SOURCE DESTINATION COMPRESS_TOOL [DEBUG_FILE]
# OPTIONS
#   SOURCE         directory to be packaged and compressed
#                  if a file is provided as SOURCE, it will get names to package
#                  and compress from SOURCE
#   DESTINATION    output file name
#   DEBUG          debug file (optional)
# RETURN VALUE
#   Last command exit status code
################################################################################
compress_data() {
    SOURCE="$1"
    DESTINATION="$2"
    DEBUG_OUTPUT="/dev/null"
    if [ "$3" ]; then
        DEBUG_OUTPUT="$3"
    fi

    if [ -d "$SOURCE" ]; then
        tar -cf - "$SOURCE" 2>> "$DEBUG_OUTPUT" | "$COMPRESS_TOOL" > "$DESTINATION" 2>> "$DEBUG_OUTPUT"
    else
        case "$PROFILE" in
            "aix"     ) tar -L "$SOURCE" -cf - 2>> "$DEBUG_OUTPUT" | "$COMPRESS_TOOL" > "$DESTINATION" 2>> "$DEBUG_OUTPUT" ;;
            "bsd"     ) tar -I "$SOURCE" -cf - 2>> "$DEBUG_OUTPUT" | "$COMPRESS_TOOL" > "$DESTINATION" 2>> "$DEBUG_OUTPUT" ;;
            "solaris" ) tar -cf - -I "$SOURCE" 2>> "$DEBUG_OUTPUT" | "$COMPRESS_TOOL" > "$DESTINATION" 2>> "$DEBUG_OUTPUT" ;;
            *         ) tar -T "$SOURCE" -cf - 2>> "$DEBUG_OUTPUT" | "$COMPRESS_TOOL" > "$DESTINATION" 2>> "$DEBUG_OUTPUT" ;;
        esac
    fi
    return
}
