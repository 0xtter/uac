# Copyright (C) 2020 IBM Corporation
#
# Licensed under the Apache License, Version 2.0 (the “License”);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an “AS IS” BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

###############################################################################
# Get user home directories.
# Globals:
#   DESTINATION_DIR
#   MOUNT_POINT
#   PROFILE
#   TMP_DATA_DIR
# Requires:
#   get_current_user
#   sanitize_path
# Arguments:
#   $1: passwd file path (default: /etc/passwd)
# Outputs:
#   Write home list to stdout.
# Exit Status:
#   Exit with status 0 on success.
#   Exit with status greater than 0 if errors occur.
###############################################################################
get_user_home_list() {
  gu_passwd_file_path="${1:-/etc/passwd}"

  # skip users with no valid shells
  gu_no_valid_shell_grep="false$|halt$|nologin$|shutdown$|sync$|:$"

  # extract user:home from passwd file
  gu_etc_passwd=`sanitize_path "${MOUNT_POINT}/${gu_passwd_file_path}"`
  sed -e 's/#.*$//g' -e '/^ *$/d' -e '/^$/d' <"${gu_etc_passwd}" \
    | grep -v -E "${gu_no_valid_shell_grep}" \
    | awk 'BEGIN { FS=":"; } {
        printf "%s\n",$6;
      }' >>"${DESTINATION_DIR}/${TMP_DATA_DIR}/.user_home_list.tmp"

  # extract user:home from /home | /Users | /export/home
  gu_user_home_dir=`sanitize_path "${MOUNT_POINT}/home"`
  if [ "${PROFILE}" = "macos" ]; then
    gu_user_home_dir=`sanitize_path "${MOUNT_POINT}/Users"`
  elif [ "${PROFILE}" = "solaris" ]; then
    gu_user_home_dir=`sanitize_path "${MOUNT_POINT}/export/home"`
  fi

  ls "${gu_user_home_dir}" \
    | awk -v gu_users_dir="${gu_user_home_dir}" \
      '{ printf "%s/%s\n",gu_users_dir,$1 }' \
      >>"${DESTINATION_DIR}/${TMP_DATA_DIR}/.user_home_list.tmp"

  # extract home for current user
  # useful for systems which do not have a /etc/passwd file
  echo "${HOME}" >>"${DESTINATION_DIR}/${TMP_DATA_DIR}/.user_home_list.tmp"

  sort -u <"${DESTINATION_DIR}/${TMP_DATA_DIR}/.user_home_list.tmp"

  rm -f "${DESTINATION_DIR}/${TMP_DATA_DIR}/.user_home_list.tmp" \
    >/dev/null 2>/dev/null
  
}