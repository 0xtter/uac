################################################################################
# NAME
#   file_search - search for files and directories based on a set of criteria
# SYNOPSIS
#   file_search FIND_TOOL MOUNT_POINT INPUT_FILE OUTPUT_FILE [EXCLUDE_FILE] [MAXDEPTH] [SIZE] [DATE_RANGE_T1] [DATE_RANGE_T2]
# OPTIONS
#   FIND_TOOL       find or perl "$CWD/tools/find/find.pl"
#   MOUNT_POINT     starting point
#   INPUT_FILE      input file name containing a list of file and/or directory
#                   names to be searched for
#   OUTPUT_FILE     output file name
#   EXCLUDE_FILE    file containing a list of file and/or directory names
#                   to be excluded from the search
#   MAXDEPTH        value to be used with -maxdepth
#   SIZE            value to be used with -size
#   DATE_RANGE_T1   value to be used with -atime, -mtime and -ctime
#   DATE_RANGE_T2   value to be used with -atime, -mtime and -ctime
# RETURN VALUE
#   file containing the list of file names found during the search
################################################################################
file_search() {

    LOCAL_FIND_TOOL="$1"
    LOCAL_MOUNT_POINT="$2"
    LOCAL_INPUT_FILE="$3"
    LOCAL_OUTPUT_FILE="$4"
    LOCAL_EXCLUDE_FILE="$5"
    LOCAL_FIND_MAXDEPTH=$6
    LOCAL_FIND_SIZE=$7
    LOCAL_DATE_RANGE_T1=$8
    LOCAL_DATE_RANGE_T2=$9

    LOCAL_FIND_NAME_PARAMETER=""
    LOCAL_FIND_PATH_PRUNE_PARAMETER=""
    LOCAL_FIND_NAME_PRUNE_PARAMETER=""
    LOCAL_FIND_MAXDEPTH_PARAMETER=""
    LOCAL_FIND_SIZE_PARAMETER=""

    if [ -f "$LOCAL_INPUT_FILE" ]; then

        LOCAL_FIND_NAME_PARAMETER=`cat "$LOCAL_INPUT_FILE" | grep -v "^#" | grep -v "^$" | grep -v "^/" | head -1 | while read line; do printf %s "-name \"$line\""; done; cat "$LOCAL_INPUT_FILE" | grep -v "^#" | grep -v "^$" | grep -v "^/" | sed 1d | while read line; do printf %s " -o -name \"$line\"" ;done`
        if [ ! -z "$LOCAL_FIND_NAME_PARAMETER" ]; then
            LOCAL_FIND_NAME_PARAMETER="\( $LOCAL_FIND_NAME_PARAMETER \)"
        fi

        if [ -f "$LOCAL_EXCLUDE_FILE" ]; then
            LOCAL_FIND_PATH_PRUNE_PARAMETER=`cat "$LOCAL_EXCLUDE_FILE" | grep -v "^#" | grep -v "^$" | grep "^/" | head -1 | sed 's:^/:'"$LOCAL_MOUNT_POINT"'/:; s://*:/:g; s:/$::g' | while read line; do printf %s "-path \"$line\""; done; cat "$LOCAL_EXCLUDE_FILE" | grep -v "^#" | grep -v "^$" | grep "^/" | sed 1d | sed 's:^/:'"$LOCAL_MOUNT_POINT"'/:; s://*:/:g; s:/$::g' | while read line; do printf %s " -o -path \"$line\"" ;done`
            if [ ! -z "$LOCAL_FIND_PATH_PRUNE_PARAMETER" ]; then
                LOCAL_FIND_PATH_PRUNE_PARAMETER="\( $LOCAL_FIND_PATH_PRUNE_PARAMETER \) -prune -o"
            fi
            LOCAL_FIND_NAME_PRUNE_PARAMETER=`cat "$LOCAL_EXCLUDE_FILE" | grep -v "^#" | grep -v "^$" | grep -v "^/" | head -1 | while read line; do printf %s "-name \"$line\""; done; cat "$LOCAL_EXCLUDE_FILE" | grep -v "^#" | grep -v "^$" | grep -v "^/" | sed 1d | while read line; do printf %s " -o -name \"$line\"" ;done`
            if [ ! -z "$LOCAL_FIND_NAME_PRUNE_PARAMETER" ]; then
                LOCAL_FIND_NAME_PRUNE_PARAMETER="\( $LOCAL_FIND_NAME_PRUNE_PARAMETER \) -prune -o"
            fi
        fi

        if [ "$LOCAL_FIND_MAXDEPTH" -gt 0 ]; then
            LOCAL_FIND_MAXDEPTH_PARAMETER="-maxdepth $LOCAL_FIND_MAXDEPTH"
        fi
        
        if [ "$LOCAL_FIND_SIZE" -gt 0 ]; then
            LOCAL_FIND_SIZE_PARAMETER="-size -${LOCAL_FIND_SIZE}c"
        fi

        # first we need to search for directories which names were added to LOCAL_INPUT_FILE
        if [ ! -z "$LOCAL_FIND_NAME_PARAMETER" ]; then
            run_cmd "$LOCAL_FIND_TOOL \"$LOCAL_MOUNT_POINT\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER $LOCAL_FIND_NAME_PARAMETER -type d -print" "$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths.tmp"
        fi
        # then merge the paths with the ones added to LOCAL_INPUT_FILE
        run_cmd "cat \"$LOCAL_INPUT_FILE\" | grep -v \"^#\" | grep -v \"^$\" | grep \"^/\" | sed 's:^/:'\"$LOCAL_MOUNT_POINT\"'/:; s://*:/:g; s:/$::g'" "$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths.tmp"       
        run_cmd "cat \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths.tmp\" | sort | uniq" "$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp"
        
        if [ "$LOCAL_DATE_RANGE_T1" ]; then

            LOCAL_FIND_ATIME_PARAMETER=""
            LOCAL_FIND_MTIME_PARAMETER=""
            LOCAL_FIND_CTIME_PARAMETER=""
            
            $DATE_RANGE_ATIME && LOCAL_FIND_ATIME_PARAMETER="-atime $LOCAL_DATE_RANGE_T1"
            $DATE_RANGE_MTIME && LOCAL_FIND_MTIME_PARAMETER="-mtime $LOCAL_DATE_RANGE_T1"
            $DATE_RANGE_CTIME && LOCAL_FIND_CTIME_PARAMETER="-ctime $LOCAL_DATE_RANGE_T1"
            
            if [ "$LOCAL_DATE_RANGE_T2" ]; then
                $DATE_RANGE_ATIME && LOCAL_FIND_ATIME_PARAMETER="$LOCAL_FIND_ATIME_PARAMETER -atime $LOCAL_DATE_RANGE_T2"
                $DATE_RANGE_MTIME && LOCAL_FIND_MTIME_PARAMETER="$LOCAL_FIND_MTIME_PARAMETER -mtime $LOCAL_DATE_RANGE_T2"
                $DATE_RANGE_CTIME && LOCAL_FIND_CTIME_PARAMETER="$LOCAL_FIND_CTIME_PARAMETER -ctime $LOCAL_DATE_RANGE_T2"
            fi

            # search through paths
            $DATE_RANGE_ATIME && run_cmd "cat \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp\" | while read line; do $LOCAL_FIND_TOOL \"\$line\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_ATIME_PARAMETER -print; done" "${LOCAL_OUTPUT_FILE}.tmp"
            $DATE_RANGE_MTIME && run_cmd "cat \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp\" | while read line; do $LOCAL_FIND_TOOL \"\$line\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_MTIME_PARAMETER -print; done" "${LOCAL_OUTPUT_FILE}.tmp"
            $DATE_RANGE_CTIME && run_cmd "cat \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp\" | while read line; do $LOCAL_FIND_TOOL \"\$line\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_CTIME_PARAMETER -print; done" "${LOCAL_OUTPUT_FILE}.tmp"
            # search for the file names added to LOCAL_INPUT_FILE
            if [ ! -z "$LOCAL_FIND_NAME_PARAMETER" ]; then
                $DATE_RANGE_ATIME && run_cmd "$LOCAL_FIND_TOOL \"$LOCAL_MOUNT_POINT\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER $LOCAL_FIND_NAME_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_ATIME_PARAMETER -print" "${LOCAL_OUTPUT_FILE}.tmp"
                $DATE_RANGE_MTIME && run_cmd "$LOCAL_FIND_TOOL \"$LOCAL_MOUNT_POINT\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER $LOCAL_FIND_NAME_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_MTIME_PARAMETER -print" "${LOCAL_OUTPUT_FILE}.tmp"
                $DATE_RANGE_CTIME && run_cmd "$LOCAL_FIND_TOOL \"$LOCAL_MOUNT_POINT\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER $LOCAL_FIND_NAME_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER $LOCAL_FIND_CTIME_PARAMETER -print" "${LOCAL_OUTPUT_FILE}.tmp"
            fi

        else
            # search through paths
            run_cmd "cat \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp\" | while read line; do $LOCAL_FIND_TOOL \"\$line\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER -print; done" "${LOCAL_OUTPUT_FILE}.tmp"
            # search for the file names added to LOCAL_INPUT_FILE
            if [ ! -z "$LOCAL_FIND_NAME_PARAMETER" ]; then
                run_cmd "$LOCAL_FIND_TOOL \"$LOCAL_MOUNT_POINT\" $LOCAL_FIND_MAXDEPTH_PARAMETER $LOCAL_FIND_PATH_PRUNE_PARAMETER $LOCAL_FIND_NAME_PRUNE_PARAMETER $LOCAL_FIND_NAME_PARAMETER -type f $LOCAL_FIND_SIZE_PARAMETER -print" "${LOCAL_OUTPUT_FILE}.tmp"
            fi
        fi

        # remove UAC directory from the collection, sort and uniq
        run_cmd "cat \"${LOCAL_OUTPUT_FILE}.tmp\" | grep -v \"$CWD\" | sort | uniq" "$LOCAL_OUTPUT_FILE"

        # remove temporary files
        run_cmd "rm -f \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths.tmp\""
        run_cmd "rm -f \"$DESTINATION_DIR/$TMP_DATA_DIR/.file_search_paths_sort_uniq.tmp\""
        run_cmd "rm -f \"${LOCAL_OUTPUT_FILE}.tmp\""

    fi
}